{% extends "base.html" %}

{% set header_extra %}
<div class="mt-4 space-y-1">
  <div>Oldest merge date: <code class="bg-gray-100 px-2 py-1 rounded">{{ settings.OLDEST_VALID_PR_MERGE_DATE }}</code></div>
  <div>Oldest create date: <code class="bg-gray-100 px-2 py-1 rounded">{{ settings.OLDEST_VALID_PR_CREATE_DATE }}</code></div>
</div>
{% endset %}

{% block content %}
<div class="mb-6 flex justify-start">
  <button id="expand-all-btn" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-2.5 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm font-medium flex items-center gap-2">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
    </svg>
    Show All Usernames
  </button>
</div>
<!-- Reviewers by Load -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
  <h2 class="text-xl font-semibold text-gray-900 mb-4">Reviewers by Number of Finished PRs</h2>
  
  <!-- Color Scale -->
  <div class="mb-4">
    <p class="text-sm text-gray-600 mb-2">Color scale:</p>
    <div class="flex rounded overflow-hidden">
      {% for color in scale_colors %}
        <div class="bg-[{{ color }}] h-4 flex-1">&nbsp;</div>
      {% endfor %}
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full border-collapse">
      <thead>
        <tr class="bg-gray-50">
          <th class="border border-gray-300 p-3 text-left text-sm font-semibold">Reviewer</th>
          <th class="border border-gray-300 p-3 text-left text-sm font-semibold">Approved/Rejected</th>
          <th class="border border-gray-300 p-3 text-left text-sm font-semibold">Commented</th>
          <th class="border border-gray-300 p-3 text-left text-sm font-semibold">Requested</th>
          <th class="border border-gray-300 p-3 text-left text-sm font-semibold">No Response</th>
        </tr>
      </thead>
      <tbody>
        {% for one_reviewer_workload in workload_stats %}
          <tr class="hover:bg-gray-50">
            <td class="border border-gray-300 p-3">
              <details class="cursor-pointer">
                <summary class="text-blue-600 hover:text-blue-800 username-summary">Show username</summary>
                <span class="text-sm text-gray-700">{{ one_reviewer_workload.user }}</span>
              </details>
            </td>
            <td class="border border-gray-300 p-3">{{ one_reviewer_workload.num_of_finished_reviews }}</td>
            <td class="border border-gray-300 p-3">{{ one_reviewer_workload.prs_where_commented | length }}</td>
            <td class="border border-gray-300 p-3">{{ one_reviewer_workload.prs_where_review_was_requested | length }}</td>
            <td class="border border-gray-300 p-3">
              <div class="">
                {{ one_reviewer_workload.prs_where_no_review_response | length }} PR(s) =
                {{ one_reviewer_workload.percentage_of_prs_with_missing_review | colorful_percentage_for_missing_reviews | safe }}

                <details>
                  <summary><small>List of PRS:</small></summary>
                  <ul>
                    {% for pr_slug in one_reviewer_workload.prs_where_no_review_response %}
                      <li><a href="https://github.com/{{ pr_slug }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">{{ pr_slug }}</a></li>
                    {% endfor %}
                  </ul>
                </details>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Reviewers by Speed -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
  <h2 class="text-xl font-semibold text-gray-900 mb-4">Reviewers by Response Time</h2>
  
  <!-- Color Scale -->
  <div class="mb-4">
    <p class="text-sm text-gray-600 mb-2">Color scale:</p>
    <div class="flex rounded overflow-hidden">
      {% for color in scale_colors %}
        <div class="bg-[{{ color }}] h-4 flex-1">&nbsp;</div>
      {% endfor %}
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full border-collapse">
      <thead>
        <tr class="bg-gray-50">
          <th class="border border-gray-300 p-3 text-left text-sm font-semibold">Reviewer</th>
          <th class="border border-gray-300 p-3 text-left text-sm font-semibold">Median Response Time</th>
          <th class="border border-gray-300 p-3 text-left text-sm font-semibold">Total Reviews</th>
          <th class="border border-gray-300 p-3 text-left text-sm font-semibold">Reviews ≤ 2h</th>
          <th class="border border-gray-300 p-3 text-left text-sm font-semibold">Reviews ≤ 4h</th>
          <th class="border border-gray-300 p-3 text-left text-sm font-semibold">Reviews ≤ 1d</th>
          <th class="border border-gray-300 p-3 text-left text-sm font-semibold">No Review</th>
        </tr>
      </thead>
      <tbody>
        {% for one_reviewer_speed in speed_stats %}
          <tr class="hover:bg-gray-50">
            <td class="border border-gray-300 p-3">
              <details class="cursor-pointer">
                <summary class="text-blue-600 hover:text-blue-800 username-summary">Show username</summary>
                <span class="text-sm text-gray-700">{{ one_reviewer_speed.user }}</span>
              </details>
            </td>
            <td class="border border-gray-300 p-3 text-center">
              <code class="bg-gray-100 px-2 py-1 rounded text-xs">{{ one_reviewer_speed.avg_reaction_time_str }}</code>
            </td>
            <td class="border border-gray-300 p-3 text-center">{{ one_reviewer_speed.num_of_prs_reviewed }}</td>
            <td class="border border-gray-300 p-3 text-center">
              {% set count_2h, percent_2h = one_reviewer_speed.get_num_of_reviews_below(120) %}
              {{ count_2h }} = {{ percent_2h | colorful_percentage_for_review_time | safe }}
            </td>
            <td class="border border-gray-300 p-3 text-center">
              {% set count_4h, percent_4h = one_reviewer_speed.get_num_of_reviews_below(240) %}
              {{ count_4h }} = {{ percent_4h | colorful_percentage_for_review_time | safe }}
            </td>
            <td class="border border-gray-300 p-3 text-center">
              {% set count_1d, percent_1d = one_reviewer_speed.get_num_of_reviews_below(1440) %}
              {{ count_1d }} = {{ percent_1d | colorful_percentage_for_review_time | safe }}
            </td>
            <td class="border border-gray-300 p-3 text-center">{{ one_reviewer_speed.prs_with_no_review | length }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
details[open] .username-summary {
  display: none;
}
</style>
<script>
document.getElementById('expand-all-btn').addEventListener('click', function() {
  const allDetails = document.querySelectorAll('details');
  const usernameDetails = Array.from(allDetails).filter(detail => {
    const summary = detail.querySelector('summary');
    return summary && summary.textContent.includes('Show username');
  });
  
  const allOpen = usernameDetails.every(detail => detail.open);
  
  usernameDetails.forEach(detail => {
    detail.open = !allOpen;
  });
  
  this.textContent = allOpen ? 'Show All Usernames' : 'Hide All Usernames';
});
</script>
{% endblock %}
